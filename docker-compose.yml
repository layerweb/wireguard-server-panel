version: '3.8'

services:
  wireguardpanel:
    build: .
    image: wireguardpanel:latest
    container_name: wireguardpanel
    hostname: wireguardpanel
    restart: unless-stopped

    # Required capabilities for WireGuard
    cap_add:
      - NET_ADMIN
      - SYS_MODULE

    # Required sysctls for VPN
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1

    # Required devices for Tailscale
    devices:
      - /dev/net/tun:/dev/net/tun

    # Port mappings
    ports:
      # Web Panel (TCP)
      - "1881:1881/tcp"
      # WireGuard VPN (UDP)
      - "1881:51820/udp"

    # Persistent storage - single volume for all data
    volumes:
      - ./data:/data

    # Environment configuration
    environment:
      # Server public IP (auto-detected if empty)
      - WG_HOST=${WG_HOST:-}
      # VPN network settings
      - WG_PORT=51820
      - WG_NETWORK=${WG_NETWORK:-10.8.0.0/24}
      - WG_DNS=${WG_DNS:-1.1.1.1}
      # Panel settings
      - PANEL_PORT=1881
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin}
      # Database
      - DATABASE_PATH=/data/db/wireguard.db
      # Timezone
      - TZ=${TZ:-UTC}
      # Memory optimization (supports 500+ peers)
      - GOGC=100
      - GOMEMLIMIT=512MiB

    # Health monitoring
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:1881/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
